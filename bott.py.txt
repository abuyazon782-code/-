import os
import logging
import json
import datetime
from telegram import Update, InlineKeyboardButton, InlineKeyboardMarkup
from telegram.ext import Application, CommandHandler, MessageHandler, filters, ContextTypes, CallbackQueryHandler
import requests
from pathlib import Path
import sqlite3

# Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¨ÙˆØª
BOT_TOKEN = "7891562508:AAE_hTaz_KP2JWkoHvU0oK6cxw_7Nr4H_78"
ADMIN_ID = "7710449614"  # Ø¶Ø¹ Ø£ÙŠ Ø¯ÙŠ Ø§Ù„Ù…Ø·ÙˆØ± Ù‡Ù†Ø§

# Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„ØªØ³Ø¬ÙŠÙ„
logging.basicConfig(
    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s',
    level=logging.INFO
)

class Database:
    def __init__(self):
        self.conn = sqlite3.connect('users.db', check_same_thread=False)
        self.create_tables()
    
    def create_tables(self):
        cursor = self.conn.cursor()
        cursor.execute('''
            CREATE TABLE IF NOT EXISTS users (
                user_id INTEGER PRIMARY KEY,
                username TEXT,
                subscription_type TEXT DEFAULT 'free',
                upload_count INTEGER DEFAULT 0,
                max_uploads INTEGER DEFAULT 5,
                subscription_expiry DATE,
                join_date TIMESTAMP DEFAULT CURRENT_TIMESTAMP
            )
        ''')
        self.conn.commit()
    
    def get_user(self, user_id):
        cursor = self.conn.cursor()
        cursor.execute('SELECT * FROM users WHERE user_id = ?', (user_id,))
        user = cursor.fetchone()
        
        if not user:
            # Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø³ØªØ®Ø¯Ù… Ø¬Ø¯ÙŠØ¯
            cursor.execute('''
                INSERT INTO users (user_id, subscription_type, max_uploads, subscription_expiry)
                VALUES (?, 'free', 5, ?)
            ''', (user_id, (datetime.datetime.now() + datetime.timedelta(days=10)).date()))
            self.conn.commit()
            return self.get_user(user_id)
        
        return {
            'user_id': user[0],
            'username': user[1],
            'subscription_type': user[2],
            'upload_count': user[3],
            'max_uploads': user[4],
            'subscription_expiry': user[5],
            'join_date': user[6]
        }
    
    def increment_upload_count(self, user_id):
        cursor = self.conn.cursor()
        cursor.execute('UPDATE users SET upload_count = upload_count + 1 WHERE user_id = ?', (user_id,))
        self.conn.commit()
    
    def upgrade_user(self, user_id, plan_type):
        cursor = self.conn.cursor()
        if plan_type == 'premium':
            expiry = (datetime.datetime.now() + datetime.timedelta(days=30)).date()
            cursor.execute('''
                UPDATE users SET subscription_type = ?, max_uploads = 100, subscription_expiry = ?
                WHERE user_id = ?
            ''', ('premium', expiry, user_id))
        elif plan_type == 'vip':
            expiry = (datetime.datetime.now() + datetime.timedelta(days=365)).date()
            cursor.execute('''
                UPDATE users SET subscription_type = ?, max_uploads = 9999, subscription_expiry = ?
                WHERE user_id = ?
            ''', ('vip', expiry, user_id))
        self.conn.commit()

class FileUploaderBot:
    def __init__(self):
        self.db = Database()
        self.services = {
            'file.io': self.upload_fileio,
            'transfer.sh': self.upload_transfersh
        }
    
    async def start(self, update: Update, context: ContextTypes.DEFAULT_TYPE):
        """Ø±Ø³Ø§Ù„Ø© Ø§Ù„ØªØ±Ø­ÙŠØ¨"""
        user_id = update.effective_user.id
        user_data = self.db.get_user(user_id)
        
        welcome_text = f"""
        ğŸš€ **Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ùƒ ÙÙŠ Ø¨ÙˆØª Ø±ÙØ¹ Ø§Ù„Ù…Ù„ÙØ§Øª!**

        ğŸ‘¤ **Ø®Ø·ØªÙƒ Ø§Ù„Ø­Ø§Ù„ÙŠØ©:** {user_data['subscription_type'].upper()}
        ğŸ“Š **Ø§Ù„Ø±ÙØ¹Ø§Øª Ø§Ù„Ù…ØªØ¨Ù‚ÙŠØ©:** {user_data['upload_count']}/{user_data['max_uploads']}
        â° **Ø§Ù†ØªÙ‡Ø§Ø¡ Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ:** {user_data['subscription_expiry']}

        ğŸ“ **ÙƒÙŠÙÙŠØ© Ø§Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù…:**
        - Ø£Ø±Ø³Ù„ Ø£ÙŠ Ù…Ù„Ù ØªØ±ÙŠØ¯ Ø±ÙØ¹Ù‡
        - Ø³Ø£Ù‚ÙˆÙ… Ø¨Ø±ÙØ¹Ù‡ ÙˆØ¥Ø¹Ø§Ø¯ØªÙƒ Ø±Ø§Ø¨Ø· Ø§Ù„ØªØ­Ù…ÙŠÙ„

        ğŸ’ **Ø§Ù„Ø®Ø·Ø· Ø§Ù„Ù…ØªØ§Ø­Ø©:**
        â€¢ ğŸ†“ Ù…Ø¬Ø§Ù†ÙŠ - 5 Ø±ÙØ¹Ø§Øª Ù„Ù…Ø¯Ø© 10 Ø£ÙŠØ§Ù…
        â€¢ ğŸ’ Ø¨Ø±ÙŠÙ…ÙŠÙˆÙ… - 100 Ø±ÙØ¹Ø© Ø´Ù‡Ø±ÙŠØ§Ù‹
        â€¢ ğŸ‘‘ VIP - Ø±ÙØ¹Ø§Øª ØºÙŠØ± Ù…Ø­Ø¯ÙˆØ¯Ø© Ø³Ù†ÙˆÙŠØ§Ù‹

        Ø§Ø³ØªØ®Ø¯Ù… /plans Ù„Ø±Ø¤ÙŠØ© Ø§Ù„Ø®Ø·Ø·
        """
        
        keyboard = [
            [InlineKeyboardButton("ğŸ“¦ Ø±ÙØ¹ Ù…Ù„Ù", callback_data="upload")],
            [InlineKeyboardButton("ğŸ’ Ø§Ù„Ø®Ø·Ø·", callback_data="plans"),
             InlineKeyboardButton("ğŸ‘¤ Ø­Ø³Ø§Ø¨ÙŠ", callback_data="profile")]
        ]
        reply_markup = InlineKeyboardMarkup(keyboard)
        
        await update.message.reply_text(welcome_text, reply_markup=reply_markup)
    
    async def plans(self, update: Update, context: ContextTypes.DEFAULT_TYPE):
        """Ø¹Ø±Ø¶ Ø§Ù„Ø®Ø·Ø·"""
        plans_text = """
        ğŸ’ **Ø®Ø·Ø· Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ:**

        ğŸ†“ **Ø§Ù„Ù…Ø¬Ø§Ù†ÙŠ**
        â€¢ 5 Ø±ÙØ¹Ø§Øª ÙƒØ­Ø¯ Ø£Ù‚ØµÙ‰
        â€¢ Ù…Ø¯Ø© 10 Ø£ÙŠØ§Ù…
        â€¢ Ù…Ù„ÙØ§Øª Ø­ØªÙ‰ 2GB
        â€¢ ğŸ”“ Ù…Ø¬Ø§Ù†ÙŠ

        ğŸ’ **Ø§Ù„Ø¨Ø±ÙŠÙ…ÙŠÙˆÙ… - 5$ Ø´Ù‡Ø±ÙŠØ§Ù‹**
        â€¢ 100 Ø±ÙØ¹Ø© Ø´Ù‡Ø±ÙŠØ§Ù‹
        â€¢ Ø¯Ø¹Ù… Ø£ÙˆÙ„ÙˆÙŠØ©
        â€¢ Ù…Ù„ÙØ§Øª Ø­ØªÙ‰ 5GB
        â€¢ âš¡ Ø£Ø³Ø±Ø¹ Ø±ÙØ¹

        ğŸ‘‘ **VIP - 50$ Ø³Ù†ÙˆÙŠØ§Ù‹**
        â€¢ Ø±ÙØ¹Ø§Øª ØºÙŠØ± Ù…Ø­Ø¯ÙˆØ¯Ø©
        â€¢ Ø¯Ø¹Ù… ÙÙˆØ±ÙŠ
        â€¢ Ù…Ù„ÙØ§Øª Ø­ØªÙ‰ 10GB
        â€¢ ğŸš€ Ø£Ù‚ØµÙ‰ Ø³Ø±Ø¹Ø©

        Ù„Ù„ØªØ±Ù‚ÙŠØ© Ø±Ø§Ø³Ù„ Ø§Ù„Ù…Ø·ÙˆØ±: @xc25bb
        """
        
        keyboard = [
            [InlineKeyboardButton("ğŸ“ Ø§ØªØµÙ„ Ø¨Ø§Ù„Ù…Ø·ÙˆØ±", url="https://t.me/YourUsername")],
            [InlineKeyboardButton("ğŸ”™ Ø±Ø¬ÙˆØ¹", callback_data="back_to_start")]
        ]
        reply_markup = InlineKeyboardMarkup(keyboard)
        
        await update.message.reply_text(plans_text, reply_markup=reply_markup)
    
    async def profile(self, update: Update, context: ContextTypes.DEFAULT_TYPE):
        """Ø¹Ø±Ø¶ Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ"""
        user_id = update.effective_user.id
        user_data = self.db.get_user(user_id)
        
        # Ø­Ø³Ø§Ø¨ Ø§Ù„Ø£ÙŠØ§Ù… Ø§Ù„Ù…ØªØ¨Ù‚ÙŠØ©
        expiry_date = datetime.datetime.strptime(user_data['subscription_expiry'], '%Y-%m-%d').date()
        days_left = (expiry_date - datetime.datetime.now().date()).days
        
        profile_text = f"""
        ğŸ‘¤ **Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ**

        ğŸ†” **Ø§Ù„Ø£ÙŠØ¯ÙŠ:** {user_data['user_id']}
        ğŸ“› **Ø§Ù„Ø§Ø³Ù…:** {update.effective_user.first_name}
        ğŸ’ **Ø§Ù„Ø®Ø·Ø©:** {user_data['subscription_type'].upper()}
        ğŸ“Š **Ø§Ù„Ø±ÙØ¹Ø§Øª:** {user_data['upload_count']}/{user_data['max_uploads']}
        â° **Ø§Ù„Ø£ÙŠØ§Ù… Ø§Ù„Ù…ØªØ¨Ù‚ÙŠØ©:** {days_left} ÙŠÙˆÙ…
        ğŸ“… **Ø§Ù†ØªÙ‡Ø§Ø¡ Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ:** {user_data['subscription_expiry']}
        """
        
        keyboard = [
            [InlineKeyboardButton("ğŸ’ ØªØ±Ù‚ÙŠØ©", callback_data="plans"),
             InlineKeyboardButton("ğŸ“¦ Ø±ÙØ¹ Ù…Ù„Ù", callback_data="upload")],
            [InlineKeyboardButton("ğŸ”™ Ø±Ø¬ÙˆØ¹", callback_data="back_to_start")]
        ]
        reply_markup = InlineKeyboardMarkup(keyboard)
        
        await update.message.reply_text(profile_text, reply_markup=reply_markup)
    
    async def handle_file(self, update: Update, context: ContextTypes.DEFAULT_TYPE):
        """Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„Ù…Ø±Ø³Ù„Ø©"""
        user_id = update.effective_user.id
        user_data = self.db.get_user(user_id)
        
        # Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ©
        expiry_date = datetime.datetime.strptime(user_data['subscription_expiry'], '%Y-%m-%d').date()
        if datetime.datetime.now().date() > expiry_date:
            await update.message.reply_text("""
            âŒ Ø§Ù†ØªÙ‡Øª ØµÙ„Ø§Ø­ÙŠØ© Ø§Ø´ØªØ±Ø§ÙƒÙƒ!
            
            ğŸ“ Ù„Ù„ØªØ±Ù‚ÙŠØ© ÙˆØ±Ø¬ÙˆØ¹ Ø§Ù„Ø®Ø¯Ù…Ø©ØŒ Ø±Ø§Ø³Ù„ Ø§Ù„Ù…Ø·ÙˆØ±:
            @xc25bb
            """)
            return
        
        # Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø¹Ø¯Ø¯ Ø§Ù„Ø±ÙØ¹Ø§Øª
        if user_data['upload_count'] >= user_data['max_uploads']:
            await update.message.reply_text("""
            âŒ ÙˆØµÙ„Øª Ù„Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ Ù„Ù„Ø±ÙØ¹Ø§Øª!
            
            ğŸ’ ØªØ±Ù‚ÙŠØ© Ù„Ø®Ø·Ø© Ø£Ø¹Ù„Ù‰ Ù„Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø²ÙŠØ¯:
            /plans
            """)
            return
        
        try:
            wait_msg = await update.message.reply_text("â³ Ø¬Ø§Ø±ÙŠ Ø±ÙØ¹ Ø§Ù„Ù…Ù„Ù...")
            
            # ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù„Ù
            file = await update.message.effective_attachment.get_file()
            file_path = f"temp_{file.file_id}"
            await file.download_to_drive(file_path)
            
            # Ø±ÙØ¹ Ø§Ù„Ù…Ù„Ù
            upload_result = await self.upload_file(file_path)
            
            # Ø­Ø°Ù Ø§Ù„Ù…Ù„Ù Ø§Ù„Ù…Ø¤Ù‚Øª
            if os.path.exists(file_path):
                os.remove(file_path)
            
            # Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ù†ØªÙŠØ¬Ø©
            if upload_result['success']:
                # Ø²ÙŠØ§Ø¯Ø© Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø±ÙØ¹Ø§Øª
                self.db.increment_upload_count(user_id)
                user_data = self.db.get_user(user_id)
                
                file_name = Path(file_path).name
                response_text = f"""
                âœ… **ØªÙ… Ø±ÙØ¹ Ø§Ù„Ù…Ù„Ù Ø¨Ù†Ø¬Ø§Ø­!**

                ğŸ“ **Ø§Ù„Ù…Ù„Ù:** `{file_name}`
                ğŸ”— **Ø±Ø§Ø¨Ø· Ø§Ù„ØªØ­Ù…ÙŠÙ„:**
                `{upload_result['download_url']}`

                â° **Ù…Ø¯Ø© Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ©:** 14 ÙŠÙˆÙ…
                ğŸ“Š **Ø§Ù„Ø±ÙØ¹Ø§Øª Ø§Ù„Ù…ØªØ¨Ù‚ÙŠØ©:** {user_data['upload_count']}/{user_data['max_uploads']}
                """
                await wait_msg.edit_text(response_text)
            else:
                await wait_msg.edit_text(f"âŒ ÙØ´Ù„ ÙÙŠ Ø±ÙØ¹ Ø§Ù„Ù…Ù„Ù: {upload_result['error']}")
                
        except Exception as e:
            await update.message.reply_text(f"âŒ Ø­Ø¯Ø« Ø®Ø·Ø£: {str(e)}")
    
    async def button_handler(self, update: Update, context: ContextTypes.DEFAULT_TYPE):
        """Ù…Ø¹Ø§Ù„Ø¬Ø© Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø¥Ù†Ù„Ø§ÙŠÙ†"""
        query = update.callback_query
        await query.answer()
        
        if query.data == "plans":
            await self.plans_callback(query)
        elif query.data == "profile":
            await self.profile_callback(query)
        elif query.data == "upload":
            await self.upload_callback(query)
        elif query.data == "back_to_start":
            await self.back_to_start_callback(query)
    
    async def plans_callback(self, query):
        plans_text = """
        ğŸ’ **Ø®Ø·Ø· Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ:**

        ğŸ†“ **Ø§Ù„Ù…Ø¬Ø§Ù†ÙŠ**
        â€¢ 5 Ø±ÙØ¹Ø§Øª ÙƒØ­Ø¯ Ø£Ù‚ØµÙ‰
        â€¢ Ù…Ø¯Ø© 10 Ø£ÙŠØ§Ù…
        â€¢ Ù…Ù„ÙØ§Øª Ø­ØªÙ‰ 2GB

        ğŸ’ **Ø§Ù„Ø¨Ø±ÙŠÙ…ÙŠÙˆÙ… - 5$ Ø´Ù‡Ø±ÙŠØ§Ù‹**
        â€¢ 100 Ø±ÙØ¹Ø© Ø´Ù‡Ø±ÙŠØ§Ù‹
        â€¢ Ø¯Ø¹Ù… Ø£ÙˆÙ„ÙˆÙŠØ©

        ğŸ‘‘ **VIP - 50$ Ø³Ù†ÙˆÙŠØ§Ù‹**
        â€¢ Ø±ÙØ¹Ø§Øª ØºÙŠØ± Ù…Ø­Ø¯ÙˆØ¯Ø©
        â€¢ Ø¯Ø¹Ù… ÙÙˆØ±ÙŠ

        Ù„Ù„ØªØ±Ù‚ÙŠØ© Ø±Ø§Ø³Ù„ Ø§Ù„Ù…Ø·ÙˆØ±: @xc25bb
        """
        
        keyboard = [
            [InlineKeyboardButton("ğŸ“ Ø§ØªØµÙ„ Ø¨Ø§Ù„Ù…Ø·ÙˆØ±", url="https://t.me/YourUsername")],
            [InlineKeyboardButton("ğŸ”™ Ø±Ø¬ÙˆØ¹", callback_data="back_to_start")]
        ]
        reply_markup = InlineKeyboardMarkup(keyboard)
        await query.edit_message_text(plans_text, reply_markup=reply_markup)
    
    async def profile_callback(self, query):
        user_id = query.from_user.id
        user_data = self.db.get_user(user_id)
        
        expiry_date = datetime.datetime.strptime(user_data['subscription_expiry'], '%Y-%m-%d').date()
        days_left = (expiry_date - datetime.datetime.now().date()).days
        
        profile_text = f"""
        ğŸ‘¤ **Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ**

        ğŸ†” **Ø§Ù„Ø£ÙŠØ¯ÙŠ:** {user_data['user_id']}
        ğŸ“› **Ø§Ù„Ø§Ø³Ù…:** {query.from_user.first_name}
        ğŸ’ **Ø§Ù„Ø®Ø·Ø©:** {user_data['subscription_type'].upper()}
        ğŸ“Š **Ø§Ù„Ø±ÙØ¹Ø§Øª:** {user_data['upload_count']}/{user_data['max_uploads']}
        â° **Ø§Ù„Ø£ÙŠØ§Ù… Ø§Ù„Ù…ØªØ¨Ù‚ÙŠØ©:** {days_left} ÙŠÙˆÙ…
        """
        
        keyboard = [
            [InlineKeyboardButton("ğŸ’ ØªØ±Ù‚ÙŠØ©", callback_data="plans")],
            [InlineKeyboardButton("ğŸ”™ Ø±Ø¬ÙˆØ¹", callback_data="back_to_start")]
        ]
        reply_markup = InlineKeyboardMarkup(keyboard)
        await query.edit_message_text(profile_text, reply_markup=reply_markup)
    
    async def upload_callback(self, query):
        await query.edit_message_text("ğŸ“¦ Ø£Ø±Ø³Ù„ Ù„ÙŠ Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø°ÙŠ ØªØ±ÙŠØ¯ Ø±ÙØ¹Ù‡ Ø§Ù„Ø¢Ù†...")
    
    async def back_to_start_callback(self, query):
        user_id = query.from_user.id
        user_data = self.db.get_user(user_id)
        
        welcome_text = f"""
        ğŸš€ **Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ùƒ ÙÙŠ Ø¨ÙˆØª Ø±ÙØ¹ Ø§Ù„Ù…Ù„ÙØ§Øª!**

        ğŸ‘¤ **Ø®Ø·ØªÙƒ Ø§Ù„Ø­Ø§Ù„ÙŠØ©:** {user_data['subscription_type'].upper()}
        ğŸ“Š **Ø§Ù„Ø±ÙØ¹Ø§Øª Ø§Ù„Ù…ØªØ¨Ù‚ÙŠØ©:** {user_data['upload_count']}/{user_data['max_uploads']}

        ğŸ“ Ø£Ø±Ø³Ù„ Ø£ÙŠ Ù…Ù„Ù Ù„Ø¨Ø¯Ø¡ Ø§Ù„Ø±ÙØ¹
        """
        
        keyboard = [
            [InlineKeyboardButton("ğŸ“¦ Ø±ÙØ¹ Ù…Ù„Ù", callback_data="upload")],
            [InlineKeyboardButton("ğŸ’ Ø§Ù„Ø®Ø·Ø·", callback_data="plans"),
             InlineKeyboardButton("ğŸ‘¤ Ø­Ø³Ø§Ø¨ÙŠ", callback_data="profile")]
        ]
        reply_markup = InlineKeyboardMarkup(keyboard)
        await query.edit_message_text(welcome_text, reply_markup=reply_markup)
    
    # ÙˆØ¸Ø§Ø¦Ù Ø§Ù„Ø±ÙØ¹ (Ù†ÙØ³ Ø§Ù„Ø³Ø§Ø¨Ù‚)
    async def upload_file(self, file_path):
        for service_name, upload_func in self.services.items():
            result = upload_func(file_path)
            if result['success']:
                result['service'] = service_name
                return result
        return {'success': False, 'error': 'Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø®Ø¯Ù…Ø§Øª ØºÙŠØ± Ù…ØªØ§Ø­Ø©'}
    
    def upload_fileio(self, file_path):
        try:
            with open(file_path, 'rb') as file:
                files = {'file': file}
                response = requests.post('https://file.io', files=files)
            
            if response.status_code == 200:
                data = response.json()
                if data['success']:
                    return {'success': True, 'download_url': data['link']}
            return {'success': False, 'error': 'ÙØ´Ù„ ÙÙŠ Ø§Ù„Ø±ÙØ¹'}
        except Exception as e:
            return {'success': False, 'error': str(e)}
    
    def upload_transfersh(self, file_path):
        try:
            file_name = Path(file_path).name
            with open(file_path, 'rb') as file:
                response = requests.put(
                    f'https://transfer.sh/{file_name}',
                    files={'file': file}
                )
            
            if response.status_code == 200:
                return {'success': True, 'download_url': response.text.strip()}
            return {'success': False, 'error': f'Ø®Ø·Ø£: {response.status_code}'}
        except Exception as e:
            return {'success': False, 'error': str(e)}

# Ø£ÙˆØ§Ù…Ø± Ø§Ù„Ù…Ø·ÙˆØ±
async def admin_stats(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ù…Ø·ÙˆØ±"""
    if update.effective_user.id != ADMIN_ID:
        await update.message.reply_text("âŒ Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ ØµÙ„Ø§Ø­ÙŠØ© Ù„Ù„ÙˆØµÙˆÙ„ Ø¥Ù„Ù‰ Ù‡Ø°Ø§ Ø§Ù„Ø£Ù…Ø±.")
        return
    
    bot = context.bot_data.get('uploader_bot')
    if not bot:
        await update.message.reply_text("âŒ Ø§Ù„Ø¨ÙˆØª ØºÙŠØ± Ù…Ù‡ÙŠØ¡.")
        return
    
    cursor = bot.db.conn.cursor()
    cursor.execute('SELECT COUNT(*) FROM users')
    total_users = cursor.fetchone()[0]
    
    cursor.execute('SELECT COUNT(*) FROM users WHERE subscription_type != "free"')
    premium_users = cursor.fetchone()[0]
    
    cursor.execute('SELECT SUM(upload_count) FROM users')
    total_uploads = cursor.fetchone()[0] or 0
    
    stats_text = f"""
    ğŸ“Š **Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ø¨ÙˆØª**
    
    ğŸ‘¥ **Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†:** {total_users}
    ğŸ’ **Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø§Ù„Ù…Ù…ÙŠØ²ÙŠÙ†:** {premium_users}
    ğŸ“¦ **Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø±ÙØ¹Ø§Øª:** {total_uploads}
    ğŸ“ˆ **Ù†Ø³Ø¨Ø© Ø§Ù„Ù…Ù…ÙŠØ²ÙŠÙ†:** {((premium_users/total_users)*100 if total_users > 0 else 0):.1f}%
    """
    
    await update.message.reply_text(stats_text)

async def admin_broadcast(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """Ø¨Ø« Ø±Ø³Ø§Ù„Ø© Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†"""
    if update.effective_user.id != ADMIN_ID:
        await update.message.reply_text("âŒ Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ ØµÙ„Ø§Ø­ÙŠØ© Ù„Ù„ÙˆØµÙˆÙ„ Ø¥Ù„Ù‰ Ù‡Ø°Ø§ Ø§Ù„Ø£Ù…Ø±.")
        return
    
    if not context.args:
        await update.message.reply_text("âŒ ÙŠØ±Ø¬Ù‰ ÙƒØªØ§Ø¨Ø© Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø¨Ø¹Ø¯ Ø§Ù„Ø£Ù…Ø±.\nÙ…Ø«Ø§Ù„: /broadcast Ù…Ø±Ø­Ø¨Ø§ Ø¨Ø§Ù„Ø¬Ù…ÙŠØ¹")
        return
    
    message = ' '.join(context.args)
    bot = context.bot_data.get('uploader_bot')
    
    cursor = bot.db.conn.cursor()
    cursor.execute('SELECT user_id FROM users')
    users = cursor.fetchall()
    
    success = 0
    failed = 0
    
    for user in users:
        try:
            await context.bot.send_message(user[0], f"ğŸ“¢ Ø¥Ø´Ø¹Ø§Ø± Ù…Ù† Ø§Ù„Ù…Ø·ÙˆØ±:\n\n{message}")
            success += 1
        except:
            failed += 1
    
    await update.message.reply_text(f"âœ… ØªÙ… Ø§Ù„Ø¨Ø«:\nâ€¢ Ù†Ø¬Ø­: {success}\nâ€¢ ÙØ´Ù„: {failed}")

def main():
    """Ø§Ù„Ø¯Ø§Ù„Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©"""
    application = Application.builder().token(BOT_TOKEN).build()
    uploader = FileUploaderBot()
    
    # Ø­ÙØ¸ ÙƒØ§Ø¦Ù† Ø§Ù„Ø¨ÙˆØª ÙÙŠ context
    application.bot_data['uploader_bot'] = uploader
    
    # Ø¥Ø¶Ø§ÙØ© handlers
    application.add_handler(CommandHandler("start", uploader.start))
    application.add_handler(CommandHandler("plans", uploader.plans))
    application.add_handler(CommandHandler("profile", uploader.profile))
    application.add_handler(CommandHandler("stats", admin_stats))
    application.add_handler(CommandHandler("broadcast", admin_broadcast))
    
    # Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø£Ø²Ø±Ø§Ø±
    application.add_handler(CallbackQueryHandler(uploader.button_handler))
    
    # Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ù…Ù„ÙØ§Øª
    application.add_handler(MessageHandler(
        filters.Document.ALL | filters.PHOTO | filters.VIDEO | filters.AUDIO,
        uploader.handle_file
    ))
    
    # Ø¨Ø¯Ø¡ Ø§Ù„Ø¨ÙˆØª
    print("ğŸ¤– Ø§Ù„Ø¨ÙˆØª ÙŠØ¹Ù…Ù„ Ø¨Ù†Ø¸Ø§Ù… Freemium...")
    application.run_polling()

if __name__ == "__main__":
    main()#80FF00